<?php

class Manager_EmployeeController extends Zend_Controller_Action
{

	protected $_user_auth;
	
	public function init()
	{
		/* Initialize action controller here */
		$storage = new Zend_Auth_Storage_Session();
		$data = $storage->read();
		 
		if(!$data){
			$this->_redirect('auth/login');
		}
		 
		$this->_user_auth = $data;
		
		$this->view->user_auth = $this->_user_auth;
	        /* Initialize action controller here */
    }

    public function indexAction()
    {
        // action body
    }

    public function editAction()
    {
    	// action body
    	$group_id = (int) $this->_request->getParam('group_id');
    	$client_id = (int) $this->_request->getParam('client_id');
		$GroupMap = new Messerve_Model_Mapper_Group();
    	
    	$groups = $GroupMap->fetchList("1",'name ASC');
    	
    	$Client = new Messerve_Model_Mapper_Client();
    	
    	$clients = array();
    	
    	foreach ($Client->fetchList('1','name ASC') as $cvalue) {
    		$clients[$cvalue->getId()] = $cvalue->getName();
    	}    	
    	
    	$groups_array = array();
    	
    	foreach($groups as $gvalue) {
    		if(!isset($clients[$gvalue->getClientId()])) $clients[$gvalue->getClientId()] = '';
    		$groups_array[$gvalue->getId()] = $clients[$gvalue->getClientId()] . ': '  .$gvalue->getName();
    	}
    	
    	asort($groups_array);
    	
    	$BOPMap = new Messerve_Model_Mapper_Bop();
    	
    	foreach($BOPMap->fetchList('1') as $bopvalue) {
    		$bop_array[$bopvalue->getId()] = $bopvalue->getName();
    	} 
    	
    	$form = new Messerve_Form_EditEmployee();
    	
    	$group_select = $form->getElement('group_id');
    	
    	$groups_array = array('0'=>'Unemployed') + $groups_array;

        $this->view->groups = $groups_array;

    	$group_select->setMultiOptions($groups_array);
    	
    	$rate_select = $form->getElement('rate_id');
    	 
    	$rate_array = $this->_getRates();
    	 
    	$rate_select->setMultiOptions(array('0'=>'') + $rate_array);

    	$bop_select = $form->getElement('bop_id');
    	 
    	$bop_array = array('0'=>'') + $bop_array;
    	 
    	$bop_select->setMultiOptions($bop_array);
    	 
    	$Employee = new Messerve_Model_Employee();
    	
    	if($this->_request->isPost()) { // Save submit
    		$postvars = $this->_request->getPost();
    		 
    		if ($form->isValid($postvars)) {
    	
    			if(!$form->getValue('id') > 0) {
    				$form->removeElement('id');
    			}
    	
    			$Employee->setOptions($form->getValues())
    				->save();
    			 
    			// $this->_redirect('/manager/group/employees/id/'. $group_id);
    			$this->_redirect('/manager/client/edit/id/'. $client_id);
    			 
    		}
    	}	
    	
    	$employee_id = (int) $this->_request->getParam('id');
    	
    	if($employee_id > 0) {
	    	$Employee->find($employee_id);
	    	
	    	if($Employee->getId() > 0) {
	    		$form->populate($Employee->toArray());
	    		$this->view->employee = $Employee;
	    	}	
    	} elseif($group_id > 0) {
    		$form->populate(array('group_id'=>$group_id));
    	}
    	
    	$this->view->form = $form;  

    	
    	$client_id = $this->_request->getParam('client_id');
    	 
    	$Client = new Messerve_Model_Client();
    	$Client->find($client_id);
    	 
    	$this->view->client = $Client;    	
    }
    
    protected function _getRates() {
    	$RateMap = new Messerve_Model_Mapper_Rate();
    	
    	$rate_options = $RateMap->fetchList('1','name ASC');
    	
    	$rate_array = array(
    			// 	'0'=>'N/A'
    	);
    	 
    	foreach ($rate_options as $rovalue) {
    		$rate_array[$rovalue->getId()] = $rovalue->getName();
    	}
    	
    	return $rate_array;
    }

}



